name: Docker Build and Publish

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up QEMU
        if: matrix.platform == 'arm64'
        run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Find and build Docker images
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DOCKERFILES=$(find . -name Dockerfile -exec dirname {} \;)
          for dir in $DOCKERFILES; do
            # Получаем название репозитория в нижнем регистре
            repo_owner=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            # Формируем имя Docker образа с тегом latest
            tag="latest"
            image_name="ghcr.io/$repo_owner/$(basename $dir | tr '[:upper:]' '[:lower:]'):$tag-${{ matrix.platform }}"
            echo "Building image $image_name in directory $dir"
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
            docker build -t $image_name $dir
            docker push $image_name
          done

